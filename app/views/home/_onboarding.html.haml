.reveal-modal.expand.onboarding.large#onboarding-modal
  .large-12.columns
    .large-6.columns.no-padding
      = image_tag "onboarding-logo.jpg"

    .large-6.columns
      .step-1.right.hide
        = image_tag "step-1.png"
      .step-2.right.hide
        = image_tag "step-2.png"
      .step-3.right
        = image_tag "step-3.png"
      .step-complete.right.hide
        = image_tag "step-complete.png"

  .select-favorite-genres.step
    = render partial: "genres/favorite_genres_modal"

  .select-rating-system.step
    %h2.lead How do you want to rate your anime?
    %p.subtext Hummingbird has two rating sytems - simple and advanced. How precisely would you like to rate the anime youâ€™ve watched?

    .large-6.columns.rating-panel
      .simple.rating-system(data-system="simple")
        .row
          .small-5.columns
            Simple
          .small-7.columns.rating-example
            %i.icon-smile
            %i.icon-meh
            %i.icon-frown

    .large-6.columns.rating-panel
      .advanced.rating-system(data-system="advanced")
        .row
          .small-5.columns
            Advanced
          .small-7.columns.rating-example
            %i.icon-star
            %i.icon-star
            %i.icon-star
            %i.icon-star-half-empty
            %i.icon-star-empty
  
  .bootstrap-library.step
    .mal-import-section
      %h2.lead Let's connect your accounts elsewhere...
      %p.subtext Hummingbird can connect and import from your favorite networks and services to help you feel right at home.

      .large-6.columns.center.mal-connect
        = image_tag "mal-connect.jpg"
        %p Already have a MAL account? We can import it!
        %form.mal-import
          .large-12.columns
            .row.collapse
              .small-3.large-4.columns
                %span.prefix MAL Username
              .small-9.large-8.columns
                %input(type="text" placeholder="Enter Your MAL Username")
              .large-12.columns
                %a.button
                  %span
                    IMPORT ACCOUNT
                
      .large-6.columns.center.na-connect
        = image_tag "na-connect.jpg"
        %p.na-description Receive personalized recommendations and sync with your Activity Feed! Don't have Neon Alley? <a href="http://www.neonalley.com">Learn More!</a>
        .large-12.columns
          %a.button
            %span
              CONNECT NEON ALLEY

  .completed.step
    %h2.lead Whew... You're finished!
    %p.subtext Your Hummingbird account is setup and ready to go. Have a look at your <a href="/recommendations">recommendations</a>, find and <a href="/anime">rate the anime you've seen</a> or stop by the <a href="/community">forums</a> and say 'hello!' Hummingbird is a growing community, we're glad you're a part of it :3
    .large-12.columns.ob-bg
      = link_to (image_tag "ob-bg.jpg"), "/users/edit"
  
  .large-12.columns.navigate-steps
    .skip-this-step.button.secondary.left
      %i.icon-chevron-sign-left
      Previous Step
  
    .skip-this-step.button.right
      Next Step
      %i.icon-chevron-sign-right

  %a.close-reveal-modal &#215;

:coffee
  $ ->
    # Don't close the modal on clicking the background.
    $(document).foundation 'reveal',
      closeOnBackgroundClick: false
      close: ->
        window.location.href = "/"

    # Show the modal.
    $("#onboarding-modal").foundation 'reveal', 'open'

  # List of all steps selectors.
  steps = ['.select-favorite-genres', '.select-rating-system', '.bootstrap-library', '.completed']
  currentStep = 0

  # Make a step visible.
  showStep = (step) ->
    _.each steps, (s) ->
      $(s).slideUp()
    $(step).slideDown()
    $(".onboarding-progress").html "Step " + (currentStep+1) + " of " + (steps.length-1) + "."

  # Show the first step.
  showStep steps[currentStep]

  # Show the next step.
  nextStep = ->
    currentStep += 1
    if currentStep+1 == steps.length
      $.get "/recommendations.json"
      $(".onboarding-progress").hide()
      $(".skip-this-step").hide()
      $(".close-reveal-modal").show()
    showStep steps[currentStep]

  # Skip step element.
  $(".skip-this-step").click -> nextStep()

  # Rating system selection.
  $(".select-rating-system .rating-system").click ->
    system = $(this).attr "data-system"
    $(this).addClass "active"
    $(".onboarding-progress").html $("<i class='icon-spin icon-spinner'></i>")
    $.post "#{user_update_setting_path(current_user)}", {rating_system: system}, (d) ->
      if d
        nextStep()
      else
        alert "Something went wrong, couldn't save your rating preference."

  # Don't actually *submit* the MAL import form.
  $(".onboarding form").submit ->
    $(".onboarding form a").click()
    return false

  # MAL Import.
  $("#onboarding-modal form a").click ->
    mal_username = $("#onboarding-modal form input").val()
    if mal_username.length > 0
      $("#onboarding-modal form a span").fadeOut ->
        $("#onboarding-modal form a").html $("<i class='icon-spin icon-spinner'></i>")
      $.post("/imports/myanimelist/new.json", {mal_username: mal_username}, (d) ->
        if d
          checkImportProgress()
        else
          alert "Something went wrong, couldn't import your anime list."
      ).error ->
        alert "Something went wrong, couldn't import your anime list."

  # Check MAL import status.
  checkImportProgress = ->
    $.get "/imports/status.json", (d) ->
      if d
        $.get "/recommendations"
        $("#onboarding-modal form.mal-import a").html $("<i class='icon-ok'></i>")
        nextStep()
      else
        setTimeout checkImportProgress, 2000

